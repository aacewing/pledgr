<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pledgr Security Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .security-dashboard {
            padding: 40px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .dashboard-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .security-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-card.critical {
            border-left-color: var(--error-color);
        }
        
        .stat-card.warning {
            border-left-color: var(--warning-color);
        }
        
        .stat-card.success {
            border-left-color: var(--success-color);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .security-logs {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .logs-header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logs-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-entry.critical {
            background: #fef2f2;
            border-left: 4px solid var(--error-color);
        }
        
        .log-entry.warning {
            background: #fffbeb;
            border-left: 4px solid var(--warning-color);
        }
        
        .log-info {
            flex: 1;
        }
        
        .log-event {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .log-details {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .log-timestamp {
            color: #999;
            font-size: 0.8rem;
        }
        
        .security-actions {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .action-btn.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .action-btn.danger {
            background: var(--error-color);
            color: white;
        }
        
        .action-btn.warning {
            background: var(--warning-color);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .user-sessions {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }
        
        .sessions-header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
        }
        
        .session-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-user {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .session-details {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .session-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .btn-small.danger {
            background: var(--error-color);
            color: white;
        }
        
        .btn-small.warning {
            background: var(--warning-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="security-dashboard">
        <div class="dashboard-header">
            <h1><i class="fas fa-shield-alt"></i> Security Dashboard</h1>
            <p>Monitor authentication events and system security</p>
        </div>
        
        <div class="security-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeSessions">0</div>
                <div class="stat-label">Active Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedLogins">0</div>
                <div class="stat-label">Failed Login Attempts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="securityEvents">0</div>
                <div class="stat-label">Security Events (24h)</div>
            </div>
        </div>
        
        <div class="security-logs">
            <div class="logs-header">
                <h3><i class="fas fa-list"></i> Security Logs</h3>
                <button class="action-btn primary" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            <div class="logs-content" id="logsContent">
                <!-- Logs will be populated here -->
            </div>
        </div>
        
        <div class="user-sessions">
            <div class="sessions-header">
                <h3><i class="fas fa-users"></i> Active User Sessions</h3>
            </div>
            <div id="sessionsContent">
                <!-- Sessions will be populated here -->
            </div>
        </div>
        
        <div class="security-actions">
            <button class="action-btn primary" onclick="exportLogs()">
                <i class="fas fa-download"></i> Export Logs
            </button>
            <button class="action-btn warning" onclick="clearOldLogs()">
                <i class="fas fa-trash"></i> Clear Old Logs
            </button>
            <button class="action-btn danger" onclick="resetSecurity()">
                <i class="fas fa-exclamation-triangle"></i> Reset Security
            </button>
        </div>
    </div>
    
    <script src="auth.js"></script>
    <script>
        // Security Dashboard functionality
        function updateDashboard() {
            const users = pledgrAuth.getAllUsers();
            const logs = pledgrAuth.getSecurityLogs();
            const sessions = pledgrAuth.isAuthenticated ? 1 : 0;
            
            // Update stats
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeSessions').textContent = sessions;
            
            // Count failed logins
            const failedLogins = logs.filter(log => 
                log.event === 'login_failed' && 
                new Date(log.timestamp) > new Date(Date.now() - 24 * 60 * 60 * 1000)
            ).length;
            document.getElementById('failedLogins').textContent = failedLogins;
            
            // Count recent security events
            const recentEvents = logs.filter(log => 
                new Date(log.timestamp) > new Date(Date.now() - 24 * 60 * 60 * 1000)
            ).length;
            document.getElementById('securityEvents').textContent = recentEvents;
            
            // Update logs display
            updateLogsDisplay(logs);
            
            // Update sessions display
            updateSessionsDisplay();
        }
        
        function updateLogsDisplay(logs) {
            const logsContent = document.getElementById('logsContent');
            logsContent.innerHTML = '';
            
            // Show most recent logs first
            const recentLogs = logs.slice(-20).reverse();
            
            recentLogs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${getLogSeverity(log.event)}`;
                
                const timestamp = new Date(log.timestamp).toLocaleString();
                
                logEntry.innerHTML = `
                    <div class="log-info">
                        <div class="log-event">${log.event.replace('_', ' ').toUpperCase()}</div>
                        <div class="log-details">${log.details || 'No additional details'}</div>
                    </div>
                    <div class="log-timestamp">${timestamp}</div>
                `;
                
                logsContent.appendChild(logEntry);
            });
        }
        
        function updateSessionsDisplay() {
            const sessionsContent = document.getElementById('sessionsContent');
            sessionsContent.innerHTML = '';
            
            if (pledgrAuth.isAuthenticated && pledgrAuth.currentUser) {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                
                const lastLogin = pledgrAuth.currentUser.lastLogin ? 
                    new Date(pledgrAuth.currentUser.lastLogin).toLocaleString() : 'Never';
                
                sessionItem.innerHTML = `
                    <div class="session-info">
                        <div class="session-user">${pledgrAuth.currentUser.name}</div>
                        <div class="session-details">
                            Email: ${pledgrAuth.currentUser.email} | 
                            Role: ${pledgrAuth.currentUser.role} | 
                            Last Login: ${lastLogin}
                        </div>
                    </div>
                    <div class="session-actions">
                        <button class="btn-small warning" onclick="forceLogout()">
                            Force Logout
                        </button>
                    </div>
                `;
                
                sessionsContent.appendChild(sessionItem);
            } else {
                sessionsContent.innerHTML = '<div class="session-item">No active sessions</div>';
            }
        }
        
        function getLogSeverity(event) {
            if (event.includes('failed') || event.includes('error')) return 'critical';
            if (event.includes('warning')) return 'warning';
            return '';
        }
        
        function refreshLogs() {
            updateDashboard();
            showSuccessMessage('Logs refreshed successfully');
        }
        
        function exportLogs() {
            const logs = pledgrAuth.getSecurityLogs();
            const dataStr = JSON.stringify(logs, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pledgr-security-logs-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showSuccessMessage('Logs exported successfully');
        }
        
        function clearOldLogs() {
            if (confirm('Are you sure you want to clear logs older than 30 days?')) {
                const logs = pledgrAuth.getSecurityLogs();
                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                const filteredLogs = logs.filter(log => 
                    new Date(log.timestamp) > thirtyDaysAgo
                );
                
                localStorage.setItem('pledgr_security_logs', JSON.stringify(filteredLogs));
                updateDashboard();
                showSuccessMessage('Old logs cleared successfully');
            }
        }
        
        function resetSecurity() {
            if (confirm('Are you sure you want to reset all security settings? This will clear all logs and reset authentication.')) {
                localStorage.removeItem('pledgr_security_logs');
                localStorage.removeItem('pledgr_session');
                pledgrAuth.clearSession();
                updateDashboard();
                showSuccessMessage('Security settings reset successfully');
            }
        }
        
        function forceLogout() {
            if (confirm('Are you sure you want to force logout this user?')) {
                pledgrAuth.logout();
                updateDashboard();
                showSuccessMessage('User logged out successfully');
            }
        }
        
        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'success-message';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1000';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
            
            // Update dashboard every 30 seconds
            setInterval(updateDashboard, 30000);
        });
    </script>
</body>
</html> 